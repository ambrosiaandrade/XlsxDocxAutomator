<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivos Gerados</title>
    <link rel="stylesheet" href="style-files.css" />
</head>
<body>
<div class="container">
    <h2>Arquivos Gerados</h2>

    <!-- Resumo geral dos modelos -->
    <p class="models-summary" th:if="${!models.isEmpty()}">
        Resultado da geração dos arquivos:
        <span th:each="m, stat : ${models}">
            <span th:text="${m}"></span><span th:if="${!stat.last}">; </span>
        </span>
    </p>

    <p th:if="${groups.isEmpty()}" style="color: #6c757d;">
        Nenhum arquivo gerado para download.
        <br>
        <a class="btn btn-primary" th:href="@{/}">
            Voltar para a Home
        </a>
    </p>

    <!-- Agrupado por pessoa -->
    <div th:each="entry : ${groups}" class="person-group">
        <!-- entry.key = nome / entry.value = e-mail -->
        <h3 th:text="${entry.key}"></h3>
        <p th:text="${entry.value}"></p>

        <div class="actions">
            <a class="btn btn-sm btn-primary"
               th:href="@{/downloadGroup(person=${entry.key})}">
                Baixar .zip
            </a>
            <button class="btn btn-sm btn-secondary"
                    th:attr="data-person=${entry.key}, data-email=${entry.value}"
                    onclick="sendEmail(this)">
                Enviar por e-mail
            </button>
        </div>
    </div>

    <!-- Ações globais -->
    <div th:if="${!groups.isEmpty()}" class="all-files-actions">
        <a class="btn btn-success" th:href="@{/downloadAll}">
            Baixar todos
        </a>
        <a class="btn btn-warning" th:href="@{/sendAllEmails}">
            Enviar todos por e-mail
        </a>
    </div>

</div>

<script>
    function sendEmail(button) {
     const person = button.getAttribute('data-person');
     const email = button.getAttribute('data-email');

     fetch(`/sendEmailGroup?person=${encodeURIComponent(person)}&email=${encodeURIComponent(email)}`)
         .then(res => res.json())
         .then(data => {
             alert(data.message); // feedback
         })
         .catch(err => {
             console.error(err);
             alert('Erro ao enviar e-mail.');
         });
 }
</script>
</body>
</html>
